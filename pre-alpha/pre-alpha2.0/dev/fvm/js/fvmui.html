<!--
 * Copyright Â© 2017, Robert Gollagher.
 * SPDX-License-Identifier: GPL-3.0+
 * 
 * File:       fvmui.html
 * Author :    Robert Gollagher   robert.gollagher@freeputer.net
 * Created:    20170303
 * Updated:    20171203+
 * Version:    pre-alpha-0.0.1.31+ for FVM 2.0
-->
<!DOCTYPE html>
<html>
<head>
<title>FVM</title>
<meta charset="UTF-8">
<script src="fvm2.js"></script>
<script src="fvma.js"></script>
<script src="prg.js"></script>
<script src="prgBase64.js"></script>
<script>
window.onload = function() { 'use strict';
// Source for assembler is declared as prgSrc within prg.js
fvmSrc.textContent = prgSrc;
// Default program was loaded from prgBase64 binary and is unrelated to prgSrc
//var prg = Uint8Array.from(atob(prgBase64), c => c.charCodeAt(0)).buffer;

const NOP   = 0x00000000|0; // FIXME remove all this hardcoded program...
const HALT  = 0x1c000000|0;
var prg = new Uint32Array([NOP,HALT]).buffer; // ...FIXME

  modFVMUI = modFVMUI_init(prg);
};

// Module modFVMUI connects this UI to an FVM provided by modFVM
//   and to a Freeputer Assembler provided by modFVMA
var modFVMUI;
function modFVMUI_init(prg) { 'use strict';

  var elem = x => document.getElementById(x);
  var fvmSrc = elem('fvmSrc');
  var fvmAs = elem('fvmAs');
  var fvmStdout = elem('fvmStdout');
  const fvmInput = elem('fvmStdin');

  var fvmUsrout = elem('fvmUsrout');
  var fvmGrdout = elem('fvmGrdout');
  var fvmStdlog = elem('fvmStdlog');
  var fvmStdtrc = elem('fvmStdtrc');

  function asm() {
    clr(fvmAs);
    var fnMsg = x => fvmAs.textContent+=x+'\n';
    prg = modFVMA.makeFVMA(fnMsg).asm(fvmSrc.value);
  }

  function clr(x) {
    x.textContent = '';
  }

  function clear() {
    clr(fvmAs);
    clr(fvmStdout);
    //clr(fvmUsrout);
    //clr(fvmGrdout);
    //clr(fvmStdlog);
    clr(fvmStdtrc);
  };


  var inCursor = 0;
  function inchar() {
    var inputChars = fvmStdin.value;
    var result;
    if (inCursor < inputChars.length) {
      result = fvmStdin.value.charCodeAt(inCursor++);
    }
    return result;
  }

  function run() {
    inCursor = 0; // for fvmStdin

    var cf = modFVM.makeConfig(prg);
    var chr = x => String.fromCharCode(x);
    cf.fnStdout = x => fvmStdout.textContent+=chr(x);
    cf.fnStdin = inchar; // FIXME


    cf.fnUsrout = x => fvmUsrout.textContent+=chr(x);
    cf.fnGrdout = x => fvmGrdout.textContent+=chr(x);
    cf.fnLog = x => fvmStdlog.textContent+=chr(x);
    cf.fnTrc = x => fvmStdtrc.textContent+=x+'\n';
    //cf.fnTrc = x => fvmStdout.textContent+=x+'\n';
    var exitCode = modFVM.makeFVM(cf).run();
    cf.fnTrc("VM exit code: " + exitCode);
  };

  return {
    asm: asm,
    clear: clear,
    run : run
  };
}; // modFVMUI
</script>
<link rel="stylesheet" type="text/css" href="fvm.css">
</head>

<body>
  <div class="fvmDiv">
    <h2>FVM2 <span class="fvmWarning">Incomplete</span> pre-alpha-0.0.1.31+</h2>

    <table class="fvmMaxed">
       <tr>
        <td width="50%">
          <table class="fvmMaxed">
            <tr>
              <td>
                <table class="fvmMaxed">
                  <tr>
                    <td>
                      <b>Example Program</b>
                    </td>
                  </tr>
                  <tr>
                    <td style="vertical-align:top">
                        <textarea id="fvmSrc" class="fvmOut" rows="30" cols="80" wrap="off"></textarea>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr>
              <td>
The assembler is designed to run in <i>tiny</i> amounts of RAM.</br>
The only supported forward reference is s0000.
              </td>
            </tr>
          </table>
        </td>
        <td width="50%">
          <table class="fvmMaxed">
             <tr>
              <td>   
                <input type="button" id="assemble" value="Assemble" title="Assemble program from Source" onclick="modFVMUI.asm()"/>  
                <input type="button" id="restartFVM" value="Restart" title="Start or restart the FVM instance" onclick="modFVMUI.run()"/>
                <input type="button" id="clear" value="Clear" title="Clear previous output" onclick="modFVMUI.clear()"/>
              </td>
            </tr>
             <tr>
              <td>
              </td>
            </tr>
            <tr>
              <td>
                <table class="fvmMaxed">
                  <tr>
                    <td>
                      <b>Assembler</b>
                    </td>
                  </tr>
                  <tr>
                    <td class="fvmOut fvmMid fvmScroll">
                        <pre><code><span id="fvmAs"></span></code></pre>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>

            <tr>
              <td>
                <table class="fvmMaxed">
                  <tr>
                    <td>
                      <b>stdin</b>
                    </td>
                  </tr>
                  <tr>
                    <td class="fvmOut">
                        <input type="text" id="fvmStdin" value="1234"><br>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr>


            <tr>
              <td>
                <table class="fvmMaxed">
                  <tr>
                    <td>
                      <b>stdout</b>
                    </td>
                  </tr>
                  <tr>
                    <td class="fvmOut fvmMid fvmScroll">
                        <pre><code><span id="fvmStdout"></span></code></pre>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr>
              <td>
                <table class="fvmMaxed">
                  <tr>
                    <td>
                      <b>stdtrc</b>
                    </td>
                  </tr>
                  <tr>
                    <td class="fvmOut fvmLarge fvmScroll">
                        <pre><code><span id="fvmStdtrc"></span></code></pre>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr>
              <td>
                <!-- version was here -->
              </td>
            </tr>
          </table>
          </br>
          </br>
        </td>
      </tr>
    </table>
  </div>
</body>
</html>
